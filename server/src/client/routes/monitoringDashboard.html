<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modbus API Monitoring Dashboard</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    h1, h2, h3 {
      color: #2c3e50;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
    }
    .stat {
      font-size: 36px;
      font-weight: bold;
      margin: 10px 0;
    }
    .label {
      color: #7f8c8d;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    thead {
      background-color: #f8f9fa;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    .success { color: #27ae60; }
    .error { color: #e74c3c; }
    .warning { color: #f39c12; }
    .chart-container {
      height: 250px;
      margin-top: 20px;
    }
    .refresh-button {
      padding: 8px 16px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .refresh-button:hover {
      background-color: #2980b9;
    }
    .refresh-info {
      margin-left: 10px;
      color: #7f8c8d;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
</head>
<body>
  <h1>Modbus API Monitoring Dashboard</h1>
  <p>Real-time monitoring of Modbus API requests and performance metrics</p>
  
  <button id="refreshButton" class="refresh-button" onclick="fetchStats()">Refresh Data</button>
  <span id="lastRefresh" class="refresh-info"></span>
  
  <div class="dashboard" id="statsOverview">
    <div class="card">
      <div class="label">Total Requests</div>
      <div class="stat" id="totalRequests">-</div>
    </div>
    <div class="card">
      <div class="label">Success Rate</div>
      <div class="stat" id="successRate">-</div>
    </div>
    <div class="card">
      <div class="label">Failed Requests</div>
      <div class="stat" id="failedRequests">-</div>
    </div>
    <div class="card">
      <div class="label">Timeout Requests</div>
      <div class="stat" id="timeoutRequests">-</div>
    </div>
  </div>
  
  <div class="card">
    <h2>Request Rate (Last Hour)</h2>
    <div class="chart-container">
      <canvas id="requestRateChart"></canvas>
    </div>
  </div>
  
  <div class="card">
    <h2>Recent Requests</h2>
    <table id="recentRequestsTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>Request ID</th>
          <th>Device ID</th>
          <th>Status</th>
          <th>Response Time</th>
          <th>Readings</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="6">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div class="card">
    <h2>Recent Errors</h2>
    <table id="errorsTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>Request ID</th>
          <th>Device ID</th>
          <th>Error</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="4">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    let requestRateChart;
    
    // Format a date object to a human-readable string
    function formatDateTime(date) {
      if (typeof date === 'string') {
        date = new Date(date);
      }
      
      return date.toLocaleString();
    }
    
    // Format milliseconds to a readable duration
    function formatDuration(ms) {
      if (ms < 1000) {
        return ms + 'ms';
      } else {
        return (ms / 1000).toFixed(2) + 's';
      }
    }
    
    // Initialize the request rate chart
    function initializeChart() {
      const ctx = document.getElementById('requestRateChart').getContext('2d');
      
      requestRateChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Total',
              data: [],
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Success',
              data: [],
              borderColor: '#27ae60',
              backgroundColor: 'rgba(39, 174, 96, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Failed',
              data: [],
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Requests'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Time'
              }
            }
          }
        }
      });
    }
    
    // Update the dashboard with new data
    function updateDashboard(data) {
      // Update basic stats
      document.getElementById('totalRequests').textContent = data.stats.totalRequests;
      
      const successRate = data.stats.totalRequests > 0 
        ? Math.round((data.stats.successRequests / data.stats.totalRequests) * 100) 
        : 0;
      
      document.getElementById('successRate').textContent = successRate + '%';
      document.getElementById('successRate').className = 
        successRate > 90 ? 'stat success' : 
        successRate > 70 ? 'stat warning' : 'stat error';
      
      document.getElementById('failedRequests').textContent = data.stats.failedRequests;
      document.getElementById('timeoutRequests').textContent = data.stats.timeoutRequests;
      
      // Update recent requests table
      const recentRequestsBody = document.getElementById('recentRequestsTable').getElementsByTagName('tbody')[0];
      recentRequestsBody.innerHTML = '';
      
      if (data.stats.lastRequests && data.stats.lastRequests.length > 0) {
        data.stats.lastRequests.forEach(req => {
          const row = document.createElement('tr');
          
          // Add status class for color coding
          if (req.status === 'success') {
            row.className = 'success';
          } else if (req.status === 'failed') {
            row.className = 'error';
          } else if (req.status === 'timeout') {
            row.className = 'warning';
          }
          
          row.innerHTML = `
            <td>${formatDateTime(req.timestamp)}</td>
            <td>${req.requestId}</td>
            <td>${req.deviceId || '-'}</td>
            <td>${req.status}</td>
            <td>${formatDuration(req.elapsedMs)}</td>
            <td>${req.readings || '-'}</td>
          `;
          
          recentRequestsBody.appendChild(row);
        });
      } else {
        recentRequestsBody.innerHTML = '<tr><td colspan="6">No requests recorded yet</td></tr>';
      }
      
      // Update errors table
      const errorsBody = document.getElementById('errorsTable').getElementsByTagName('tbody')[0];
      errorsBody.innerHTML = '';
      
      if (data.stats.errors && data.stats.errors.length > 0) {
        data.stats.errors.forEach(err => {
          const row = document.createElement('tr');
          row.className = 'error';
          
          row.innerHTML = `
            <td>${formatDateTime(err.timestamp)}</td>
            <td>${err.requestId}</td>
            <td>${err.deviceId || '-'}</td>
            <td>${err.error || 'Unknown error'}</td>
          `;
          
          errorsBody.appendChild(row);
        });
      } else {
        errorsBody.innerHTML = '<tr><td colspan="4">No errors recorded</td></tr>';
      }
      
      // Update request rate chart
      updateRequestRateChart(data.stats.requestsByMinute);
      
      // Update last refresh time
      document.getElementById('lastRefresh').textContent = `Last refreshed: ${formatDateTime(new Date())}`;
    }
    
    // Update the request rate chart with new data
    function updateRequestRateChart(requestsByMinute) {
      if (!requestRateChart) return;
      
      // Convert object to sorted array by minute
      const minutes = Object.keys(requestsByMinute).sort();
      
      // Prepare data for chart
      const totalData = [];
      const successData = [];
      const failedData = [];
      
      minutes.forEach(minute => {
        const stats = requestsByMinute[minute];
        totalData.push(stats.total);
        successData.push(stats.success);
        failedData.push(stats.failed + stats.timeout);
      });
      
      // Update chart
      requestRateChart.data.labels = minutes;
      requestRateChart.data.datasets[0].data = totalData;
      requestRateChart.data.datasets[1].data = successData;
      requestRateChart.data.datasets[2].data = failedData;
      requestRateChart.update();
    }
    
    // Fetch stats from the server
    async function fetchStats() {
      try {
        const response = await fetch('/monitoring/stats');
        const data = await response.json();
        
        updateDashboard(data);
      } catch (error) {
        console.error('Error fetching stats:', error);
        alert('Failed to fetch monitoring data. Please try again.');
      }
    }
    
    // Initialize on page load
    window.onload = function() {
      initializeChart();
      fetchStats();
      
      // Auto-refresh every 30 seconds
      setInterval(fetchStats, 30000);
    };
  </script>
</body>
</html>