<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MACSYS Log Viewer</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    h1, h2 {
      color: #2c3e50;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .log-viewer {
      background-color: #1e1e1e;
      color: #f1f1f1;
      font-family: monospace;
      padding: 15px;
      border-radius: 5px;
      height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    .log-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .log-controls select {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .log-controls button {
      padding: 8px 16px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .log-controls button:hover {
      background-color: #2980b9;
    }
    .log-line {
      margin: 2px 0;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .log-line.error { color: #e74c3c; }
    .log-line.warn { color: #f39c12; }
    .log-line.info { color: #2ecc71; }
    .log-line.debug { color: #3498db; }
    .tabs {
      display: flex;
      margin-bottom: 10px;
    }
    .tab {
      padding: 10px 20px;
      border: 1px solid #ddd;
      background-color: #f8f9fa;
      cursor: pointer;
    }
    .tab.active {
      background-color: #e9ecef;
      border-bottom: 2px solid #3498db;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .timestamp {
      color: #95a5a6;
      margin-right: 10px;
    }
    .log-line:hover {
      background-color: #2c3e50;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MACSYS Log Viewer</h1>
    <p>This is a simple utility to view logs from your MACSYS server.</p>
    
    <div class="tabs">
      <div class="tab active" data-tab="modbus">Modbus Logs</div>
      <div class="tab" data-tab="api">API Logs</div>
      <div class="tab" data-tab="access">Access Logs</div>
    </div>
    
    <div class="tab-content active" id="modbus-tab">
      <div class="log-controls">
        <select id="modbus-log-level">
          <option value="all">All Levels</option>
          <option value="error">Errors Only</option>
          <option value="warn">Warnings & Errors</option>
          <option value="info">Info & Above</option>
        </select>
        <button id="refresh-modbus">Refresh</button>
        <button id="clear-modbus">Clear</button>
      </div>
      <div class="log-viewer" id="modbus-logs"></div>
    </div>
    
    <div class="tab-content" id="api-tab">
      <div class="log-controls">
        <select id="api-log-level">
          <option value="all">All Levels</option>
          <option value="error">Errors Only</option>
          <option value="warn">Warnings & Errors</option>
          <option value="info">Info & Above</option>
        </select>
        <button id="refresh-api">Refresh</button>
        <button id="clear-api">Clear</button>
      </div>
      <div class="log-viewer" id="api-logs"></div>
    </div>
    
    <div class="tab-content" id="access-tab">
      <div class="log-controls">
        <button id="refresh-access">Refresh</button>
        <button id="clear-access">Clear</button>
      </div>
      <div class="log-viewer" id="access-logs"></div>
    </div>
  </div>
  
  <script>
    // Function to fetch and parse log files
    async function fetchLogs(logType) {
      try {
        const response = await fetch(`/monitoring/logs?type=${logType}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data.lines || [];
      } catch (error) {
        console.error('Error fetching logs:', error);
        return [`Error fetching logs: ${error.message}`];
      }
    }
    
    // Function to display logs in the viewer
    function displayLogs(logType, logLevel = 'all') {
      const logsContainer = document.getElementById(`${logType}-logs`);
      
      fetchLogs(logType).then(logs => {
        logsContainer.innerHTML = '';
        
        if (logs.length === 0) {
          logsContainer.innerHTML = '<div class="log-line">No logs found</div>';
          return;
        }
        
        logs.forEach(log => {
          // Parse log level from the log line
          let level = 'info';
          if (log.includes('ERROR') || log.includes('error:')) level = 'error';
          else if (log.includes('WARN') || log.includes('warning:')) level = 'warn';
          else if (log.includes('DEBUG')) level = 'debug';
          
          // Filter by log level
          if (logLevel === 'error' && level !== 'error') return;
          if (logLevel === 'warn' && level !== 'error' && level !== 'warn') return;
          if (logLevel === 'info' && level === 'debug') return;
          
          // Parse timestamp
          const timestamp = log.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/);
          const timestampStr = timestamp ? timestamp[0] : '';
          
          // Create log line element
          const logLine = document.createElement('div');
          logLine.className = `log-line ${level}`;
          
          if (timestampStr) {
            const timestampElement = document.createElement('span');
            timestampElement.className = 'timestamp';
            timestampElement.textContent = timestampStr;
            logLine.appendChild(timestampElement);
          }
          
          // Add log content
          const contentSpan = document.createElement('span');
          contentSpan.textContent = log;
          logLine.appendChild(contentSpan);
          
          logsContainer.appendChild(logLine);
        });
        
        // Scroll to bottom
        logsContainer.scrollTop = logsContainer.scrollHeight;
      });
    }
    
    // Tab switching functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to current tab
        this.classList.add('active');
        const tabName = this.getAttribute('data-tab');
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        // Load logs for the active tab
        displayLogs(tabName);
      });
    });
    
    // Event listeners for buttons
    document.getElementById('refresh-modbus').addEventListener('click', () => {
      const level = document.getElementById('modbus-log-level').value;
      displayLogs('modbus', level);
    });
    
    document.getElementById('clear-modbus').addEventListener('click', () => {
      document.getElementById('modbus-logs').innerHTML = '';
    });
    
    document.getElementById('refresh-api').addEventListener('click', () => {
      const level = document.getElementById('api-log-level').value;
      displayLogs('api', level);
    });
    
    document.getElementById('clear-api').addEventListener('click', () => {
      document.getElementById('api-logs').innerHTML = '';
    });
    
    document.getElementById('refresh-access').addEventListener('click', () => {
      displayLogs('access');
    });
    
    document.getElementById('clear-access').addEventListener('click', () => {
      document.getElementById('access-logs').innerHTML = '';
    });
    
    // Log level filter change handlers
    document.getElementById('modbus-log-level').addEventListener('change', () => {
      const level = document.getElementById('modbus-log-level').value;
      displayLogs('modbus', level);
    });
    
    document.getElementById('api-log-level').addEventListener('change', () => {
      const level = document.getElementById('api-log-level').value;
      displayLogs('api', level);
    });
    
    // Initial load
    displayLogs('modbus');
  </script>
</body>
</html>